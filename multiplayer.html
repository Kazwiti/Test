<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Truth or Dare Multiplayer Room</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: #eee;
    text-align: center;
    padding: 20px;
  }
  input, select, button {
    padding: 10px 15px;
    margin: 5px;
    font-size: 1rem;
    border-radius: 8px;
    border: none;
  }
  button {
    cursor: pointer;
  }
  button:disabled {
    opacity: 0.5;
    cursor: default;
  }
  #player-list {
    margin: 10px 0;
    font-weight: bold;
  }
  #challenge {
    margin-top: 30px;
    padding: 20px;
    background: #222;
    border-radius: 12px;
    min-height: 100px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
  }
  #challenge p {
    font-size: 1.2rem;
    user-select: text;
  }
  #scoreboard {
    max-width: 400px;
    margin: 14px auto;
    background: #222;
    border-radius: 8px;
    padding: 10px;
    text-align: left;
  }
  #scoreboard ul {
    list-style: none;
    padding: 6px 0;
    margin: 0;
  }
  #scoreboard li {
    margin: 4px 0;
  }
  label {
    font-weight: bold;
  }
  #roomInfo {
    margin-top: 8px;
    font-size: 0.95rem;
    color: #ddd;
  }
  #completionButtons {
    margin-top: 12px;
  }
</style>
</head>
<body>

<h1>Truth or Dare - Multiplayer Room</h1>

<!-- Room controls -->
<div>
  <input type="text" id="roomInput" placeholder="Enter or create room code" aria-label="Room code" />
  <button id="createRoomBtn">Create Room</button>
  <button id="joinRoomBtn">Join Room</button>
  <div id="roomInfo" aria-live="polite"></div>
</div>

<!-- Player input -->
<div>
  <input type="text" id="player-name" placeholder="Enter player name" aria-label="Player name" />
  <label for="player-gender">Gender:</label>
  <select id="player-gender" aria-label="Player gender">
    <option value="male" selected>Male</option>
    <option value="female">Female</option>
  </select>
  <button id="addPlayerBtn" disabled>Add Player</button>
</div>

<div id="player-list" aria-live="polite" aria-atomic="true">Players: None</div>

<div>
  <button id="truthBtn" disabled>Truth</button>
  <button id="dareBtn" disabled>Dare</button>
</div>

<div id="challenge" role="region" aria-live="polite" aria-atomic="true">
  <p>Add players and join a room to start!</p>
</div>

<div id="scoreboard" aria-live="polite" aria-atomic="true"><strong>Scoreboard</strong><ul><li>No players yet.</li></ul></div>

<div id="completionButtons" style="display:none;">
  <input id="completePlayerInput" placeholder="Player who completed (name)" aria-label="Player who completed challenge" />
  <button id="completedBtn" style="background-color:#4CAF50;color:#fff;">Completed</button>
  <button id="failedBtn" style="background-color:#f44336;color:#fff;margin-left:6px;">Failed</button>
</div>

<!-- Firebase Realtime Database (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // Firebase config - replace with your actual config
  const firebaseConfig = {
    apiKey: "AIzaSyDNSy0zdokELU4CxSoy7zJXHAuBPQqLaO0",
    authDomain: "truthor-dare-multiplayer.firebaseapp.com",
    databaseURL: "https://truthor-dare-multiplayer-default-rtdb.firebaseio.com",
    projectId: "truthor-dare-multiplayer",
    storageBucket: "truthor-dare-multiplayer.appspot.com",
    messagingSenderId: "51895740835",
    appId: "1:51895740835:web:783c3755a60ca0ad831216"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const rdb = firebase.database();

  // State variables
  let roomCode = null;
  const localClientId = Math.random().toString(36).slice(2,10);
  const players = [];
  const scoreboard = {};
  let mode = "spicy"; // fixed mode for simplicity, can add UI to change if needed

  // UI references
  const roomInput = document.getElementById('roomInput');
  const createRoomBtn = document.getElementById('createRoomBtn');
  const joinRoomBtn = document.getElementById('joinRoomBtn');
  const roomInfo = document.getElementById('roomInfo');

  const playerNameInput = document.getElementById('player-name');
  const playerGenderSelect = document.getElementById('player-gender');
  const addPlayerBtn = document.getElementById('addPlayerBtn');

  const playerListDiv = document.getElementById('player-list');
  const truthBtn = document.getElementById('truthBtn');
  const dareBtn = document.getElementById('dareBtn');
  const challengeDiv = document.getElementById('challenge');
  const scoreboardDiv = document.getElementById('scoreboard');

  const completionButtonsDiv = document.getElementById('completionButtons');
  const completePlayerInput = document.getElementById('completePlayerInput');
  const completedBtn = document.getElementById('completedBtn');
  const failedBtn = document.getElementById('failedBtn');

  // Enable add player button only if name entered
  playerNameInput.addEventListener('input', () => {
    addPlayerBtn.disabled = playerNameInput.value.trim() === '';
  });

  // Create or Join room
  createRoomBtn.addEventListener('click', () => {
    const code = Math.random().toString(36).slice(2,8).toUpperCase();
    roomInput.value = code;
    joinRoom(code);
  });
  joinRoomBtn.addEventListener('click', () => {
    const code = roomInput.value.trim().toUpperCase();
    if (!code) {
      alert('Please enter a room code to join or create.');
      return;
    }
    joinRoom(code);
  });

  // Join room function: sets listeners and syncs data
  function joinRoom(code) {
    if (roomCode) {
      // Clean up old listeners if any
      rdb.ref(`rooms/${roomCode}/players`).off();
      rdb.ref(`rooms/${roomCode}/currentChallenge`).off();
      rdb.ref(`rooms/${roomCode}/scoreboard`).off();
    }
    roomCode = code;
    roomInfo.textContent = `Joined room: ${roomCode}`;

    // Initialize room if not exist
    const roomRef = rdb.ref(`rooms/${roomCode}`);
    roomRef.once('value').then(snapshot => {
      if (!snapshot.exists()) {
        roomRef.set({
          createdAt: Date.now(),
          mode: mode,
          currentChallenge: null,
          scoreboard: {},
          players: {}
        }).catch(console.error);
      }
    });

    // Listen for players changes
    rdb.ref(`rooms/${roomCode}/players`).on('value', snapshot => {
      const playersData = snapshot.val() || {};
      players.length = 0; // clear local
      for (const key in playersData) {
        if (Object.hasOwn(playersData, key)) {
          players.push(playersData[key]);
        }
      }
      updatePlayerList();
      updateButtonsState();
      renderScoreboard();
    });

    // Listen for challenge changes
    rdb.ref(`rooms/${roomCode}/currentChallenge`).on('value', snapshot => {
      const challenge = snapshot.val();
      if (challenge) {
        showChallenge(challenge);
        completionButtonsDiv.style.display = "block";
      } else {
        challengeDiv.innerHTML = "<p>Choose Truth or Dare and have fun!</p>";
        completionButtonsDiv.style.display = "none";
      }
    });

    // Listen for scoreboard changes
    rdb.ref(`rooms/${roomCode}/scoreboard`).on('value', snapshot => {
      const sb = snapshot.val() || {};
      Object.keys(sb).forEach(k => scoreboard[k] = sb[k]);
      renderScoreboard();
    });
  }

  // Add player to Firebase
  addPlayerBtn.addEventListener('click', () => {
    const name = playerNameInput.value.trim();
    const gender = playerGenderSelect.value;
    if (!name) return;
    // Avoid duplicates
    if (players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
      alert('Player name already exists');
      return;
    }
    if (!roomCode) {
      alert('Join or create a room first.');
      return;
    }
    const key = name.toLowerCase();
    const playerObj = { name, gender };
    rdb.ref(`rooms/${roomCode}/players/${key}`).set(playerObj)
      .then(() => {
        playerNameInput.value = '';
        addPlayerBtn.disabled = true;
        playerNameInput.focus();
      })
      .catch(console.error);
  });

  // Remove player function - for demonstration, not UI connected
  // Could add a remove button per player in UI if desired

  // Utility: pick random from array
  function pickRandom(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  // Build challenge object
  function buildChallengeObj(player, type, text) {
    return { player, type, text, timestamp: Date.now() };
  }

  // Push challenge to Firebase
  function pushChallengeToDB(obj) {
    if (!roomCode) return;
    rdb.ref(`rooms/${roomCode}/currentChallenge`).set(obj).catch(console.error);
  }

  // Challenges data (minimal examples for demo; replace with your full lists)
  const spicyTruths = [
    "What's your wildest fantasy?",
    "Have you ever lied to get out of trouble?"
  ];
  const spicyDares = [
    { gender: "both", text: "Send a flirty selfie." },
    { gender: "both", text: "Do 10 jumping jacks loudly." }
  ];
  const funTruths = [
    "What's your favorite joke?",
    "What's the weirdest food you like?"
  ];
  const funDares = [
    { gender: "both", text: "Sing your favorite song chorus." },
    { gender: "both", text: "Dance like nobody's watching for 10 seconds." }
  ];

  // Generate challenge
  function getChallenge(type) {
    if (players.length === 0) return { player: null, text: "Add players first!" };
    const player = pickRandom(players);
    if (mode === "spicy") {
      if (type === "truth") {
        const text = pickRandom(spicyTruths);
        const obj = buildChallengeObj(player, "truth", text);
        pushChallengeToDB(obj);
        return { player, text };
      } else {
        const filtered = spicyDares.filter(d => d.gender === "both" || d.gender === player.gender);
        if (filtered.length === 0) return { player, text: "No dares available." };
        const text = pickRandom(filtered).text;
        const obj = buildChallengeObj(player, "dare", text);
        pushChallengeToDB(obj);
        return { player, text };
      }
    } else { // fun mode (not used here)
      if (type === "truth") {
        const text = pickRandom(funTruths);
        const obj = buildChallengeObj(player, "truth", text);
        pushChallengeToDB(obj);
        return { player, text };
      } else {
        const text = pickRandom(funDares).text;
        const obj = buildChallengeObj(player, "dare", text);
        pushChallengeToDB(obj);
        return { player, text };
      }
    }
  }

  // Show challenge in UI
  function showChallenge(challenge) {
    if (!challenge || !challenge.player) {
      challengeDiv.innerHTML = `<p>${challenge && challenge.text ? challenge.text : "Add players first!"}</p>`;
      return;
    }
    const name = challenge.player.name || challenge.player;
    const capType = challenge.type ? challenge.type.charAt(0).toUpperCase() + challenge.type.slice(1) : "Challenge";
    challengeDiv.innerHTML = `<p><strong>${name}'s ${capType}:</strong> ${challenge.text}</p>`;
  }

  // Update player list UI
  function updatePlayerList() {
    if (players.length === 0) {
      playerListDiv.textContent = 'Players: None';
      return;
    }
    const names = players.map(p => `${p.name} (${p.gender})`);
    playerListDiv.textContent = 'Players: ' + names.join(', ');
  }

  // Enable Truth/Dare buttons only if players exist
  function updateButtonsState() {
    const hasPlayers = players.length > 0 && !!roomCode;
    truthBtn.disabled = !hasPlayers;
    dareBtn.disabled = !hasPlayers;
  }

  // Render scoreboard UI
  function renderScoreboard() {
    if (players.length === 0) {
      scoreboardDiv.innerHTML = '<strong>Scoreboard</strong><ul><li>No players yet.</li></ul>';
      return;
    }
    let html = '<strong>Scoreboard</strong><ul>';
    players.forEach(p => {
      const pts = scoreboard[p.name] || 0;
      html += `<li>${p.name}: ${pts} point${pts === 1 ? '' : 's'}</li>`;
    });
    html += '</ul>';
    scoreboardDiv.innerHTML = html;
  }

  // Award point and sync to Firebase
  function awardPoint(playerName) {
    scoreboard[playerName] = (scoreboard[playerName] || 0) + 1;
    renderScoreboard();
    if (roomCode) {
      rdb.ref(`rooms/${roomCode}/scoreboard/${playerName}`).set(scoreboard[playerName]).catch(console.error);
    }
  }

  // Completed and Failed buttons
  completedBtn.addEventListener('click', () => {
    const pname = completePlayerInput.value.trim();
    if (!pname) {
      alert('Enter player name who completed the challenge.');
      return;
    }
    if (!players.find(p => p.name.toLowerCase() === pname.toLowerCase())) {
      alert('Player not found in this room.');
      return;
    }
    awardPoint(pname);
    completePlayerInput.value = '';
    if (roomCode) {
      rdb.ref(`rooms/${roomCode}/currentChallenge`).set(null).catch(console.error);
    }
    challengeDiv.innerHTML = "<p>Choose Truth or Dare and have fun!</p>";
    completionButtonsDiv.style.display = "none";
  });
  failedBtn.addEventListener('click', () => {
    completePlayerInput.value = '';
    if (roomCode) {
      rdb.ref(`rooms/${roomCode}/currentChallenge`).set(null).catch(console.error);
    }
    challengeDiv.innerHTML = "<p>Challenge failed — next turn!</p>";
    completionButtonsDiv.style.display = "none";
  });

  // Truth and Dare button clicks
  truthBtn.addEventListener('click', () => {
    getChallenge("truth");
  });
  dareBtn.addEventListener('click', () => {
    getChallenge("dare");
  });

  // Initial UI state
  updateButtonsState();
  updatePlayerList();
  renderScoreboard();

</script>

</body>
</html>