<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Truth or Dare - Extremely Naughty Edition</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: #eee;
    text-align: center;
    padding: 20px;
  }
  input, select, button {
    padding: 10px 15px;
    margin: 5px;
    font-size: 1rem;
    border-radius: 8px;
    border: none;
  }
  button {
    cursor: pointer;
  }
  button:disabled {
    opacity: 0.5;
    cursor: default;
  }
  #player-list {
    margin: 10px 0;
    font-weight: bold;
  }
  #challenge {
    margin-top: 30px;
    padding: 20px;
    background: #222;
    border-radius: 12px;
    min-height: 100px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
  }
  #challenge p {
    font-size: 1.2rem;
    user-select: text;
  }
  label {
    font-weight: bold;
  }
  #mode-select {
    margin-top: 15px;
  }
  #lobby {
    margin-bottom: 12px;
  }
  #roomInfo {
    margin-top: 8px;
    font-size: 0.95rem;
    color: #ddd;
  }
</style>
</head>
<body>

<h1>Truth or Dare - Extremely Naughty Edition</h1>

<!-- Login system -->
<div id="loginSection">
  <input type="text" id="usernameInput" placeholder="Enter username" aria-label="Username" />
  <button id="loginBtn">Login</button>
</div>

<div id="gameSection" style="display:none;">
  <div id="roomInfo" aria-live="polite"></div>

  <div id="player-list" aria-live="polite" aria-atomic="true">Players: None</div>

  <div id="mode-select">
    <label for="mode">Choose game mode:</label>
    <select id="mode" aria-label="Game mode">
      <option value="spicy" selected>Extremely Naughty</option>
      <option value="fun">Fun</option>
    </select>
  </div>

  <div>
    <button id="truthBtn" disabled>Truth</button>
    <button id="dareBtn" disabled>Dare</button>
  </div>

  <div id="challenge" role="region" aria-live="polite" aria-atomic="true">
    <p>Add players to start the game!</p>
  </div>
</div>

<!-- Firebase Realtime Database (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDNSy0zdokELU4CxSoy7zJXHAuBPQqLaO0",
    authDomain: "truthor-dare-multiplayer.firebaseapp.com",
    databaseURL: "https://truthor-dare-multiplayer-default-rtdb.firebaseio.com",
    projectId: "truthor-dare-multiplayer",
    storageBucket: "truthor-dare-multiplayer.firebasestorage.app",
    messagingSenderId: "51895740835",
    appId: "1:51895740835:web:783c3755a60ca0ad831216",
    measurementId: "G-V857KJ9N6L"
  };

  firebase.initializeApp(firebaseConfig);
  const rdb = firebase.database();

  let username = "";
  let gender = "";
  let players = [];
  let mode = "spicy";
  let gameId = "main-room"; // fixed room

  const loginBtn = document.getElementById("loginBtn");
  const usernameInput = document.getElementById("usernameInput");
  const loginSection = document.getElementById("loginSection");
  const gameSection = document.getElementById("gameSection");
  const roomInfo = document.getElementById("roomInfo");
  const modeSelect = document.getElementById("mode");
  const truthBtn = document.getElementById("truthBtn");
  const dareBtn = document.getElementById("dareBtn");
  const challengeDiv = document.getElementById("challenge");

  loginBtn.addEventListener("click", () => {
    const name = usernameInput.value.trim();
    const gen = prompt("Enter your gender (male/female)").toLowerCase();
    if (!name) {
      alert("Please enter a username.");
      return;
    }
    if (gen !== "male" && gen !== "female") {
      alert("Gender must be male or female.");
      return;
    }

    // Check DB for player count before adding
    rdb.ref(`games/${gameId}/players`).once("value").then(snapshot => {
      const currentPlayers = snapshot.val() || {};
      const playerCount = Object.keys(currentPlayers).length;
      if (playerCount >= 2) {
        alert("Room is full. Only 2 players allowed.");
        return;
      }
      username = name;
      gender = gen;
      addPlayerToRoom(username, gender);
      loginSection.style.display = "none";
      gameSection.style.display = "block";
      roomInfo.textContent = `You are in room: ${gameId}`;
      listenForPlayers();
      listenForChallenges();
      listenForMode();
    });
  });

  function addPlayerToRoom(name, gender) {
    const playerRef = rdb.ref(`games/${gameId}/players/${name}`);
    playerRef.set({ name, gender });
  }

  function listenForPlayers() {
    rdb.ref(`games/${gameId}/players`).on("value", snapshot => {
      const playersData = snapshot.val() || {};
      players = Object.values(playersData);
      updatePlayerList();
      updateButtonsState();
    });
  }

  function listenForChallenges() {
    rdb.ref(`games/${gameId}/currentChallenge`).on("value", snapshot => {
      const challenge = snapshot.val();
      if (challenge) {
        challengeDiv.innerHTML = `<p><strong>${challenge.player}</strong> chose <em>${challenge.type}</em>: ${challenge.text}</p>`;
      }
    });
  }

  function listenForMode() {
    rdb.ref(`games/${gameId}/mode`).on("value", snapshot => {
      const newMode = snapshot.val();
      if (newMode) {
        mode = newMode;
        modeSelect.value = newMode;
      }
    });
  }

  function updatePlayerList() {
    document.getElementById("player-list").textContent = 
      players.length ? "Players: " + players.map(p => p.name).join(", ") : "Players: None";
  }

  function updateButtonsState() {
    const isTwoPlayers = players.length === 2;
    truthBtn.disabled = !isTwoPlayers;
    dareBtn.disabled = !isTwoPlayers;
  }

  truthBtn.addEventListener("click", () => pickChallenge("truth"));
  dareBtn.addEventListener("click", () => pickChallenge("dare"));

  modeSelect.addEventListener("change", () => {
    mode = modeSelect.value;
    rdb.ref(`games/${gameId}/mode`).set(mode);
  });

  function pickChallenge(type) {
    const activePlayer = players[Math.floor(Math.random() * players.length)];
    let challengeText = "";

    if (mode === "spicy") {
      if (activePlayer.gender === "male") {
        challengeText = type === "truth" 
          ? questionSets.spicy.male.truths[Math.floor(Math.random() * questionSets.spicy.male.truths.length)] 
          : questionSets.spicy.male.dares[Math.floor(Math.random() * questionSets.spicy.male.dares.length)];
      } else {
        challengeText = type === "truth" 
          ? questionSets.spicy.female.truths[Math.floor(Math.random() * questionSets.spicy.female.truths.length)] 
          : questionSets.spicy.female.dares[Math.floor(Math.random() * questionSets.spicy.female.dares.length)];
      }
    } else {
      if (activePlayer.gender === "male") {
        challengeText = type === "truth" 
          ? questionSets.fun.male.truths[Math.floor(Math.random() * questionSets.fun.male.truths.length)] 
          : questionSets.fun.male.dares[Math.floor(Math.random() * questionSets.fun.male.dares.length)];
      } else {
        challengeText = type === "truth" 
          ? questionSets.fun.female.truths[Math.floor(Math.random() * questionSets.fun.female.truths.length)] 
          : questionSets.fun.female.dares[Math.floor(Math.random() * questionSets.fun.female.dares.length)];
      }
    }

    const challengeObj = { player: activePlayer.name, type, text: challengeText };
    rdb.ref(`games/${gameId}/currentChallenge`).set(challengeObj);
  }
</script>

<!-- Load Questions -->
<script src="questions.js"></script>

</body>
</html>